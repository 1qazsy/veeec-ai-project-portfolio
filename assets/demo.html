<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="theme-color" content="#000000" />
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=1">
</head>

<body>
  <div id="log"></div>
  <script src="https://www.zsy96115.top/verification-code/sdk/veeeci-ai.js"></script>

  <script>
    window.document.addEventListener('message', function (RnData) {
      window.ReactNativeWebView.postMessage(JSON.stringify(RnData))
    }, false);

    var debug = false;
    var indexVersion = '0.0.1-test'
    var logEle = document.getElementById('log');
    var isOffline = false;
    function log(str) {
      if (!debug) {
        return;
      }
      var p = document.createElement('p');
      p.appendChild(document.createTextNode(str));
      logEle.insertBefore(p, logEle.firstChild);
      // 同时将错误输出到控制台
      console.log(str);
    }


    (function () {
      // 错误构造函数
      function newError(msg, code, detail) {
        return {
          desc: {
            indexVersion: indexVersion,
            detail: detail
          },
          msg: msg,
          code: code
        }
      }
      function uploadExtraData(type, extraData) {
        var self = window;
        // 参数应该存在length属性，并且参数长度不可超过限制
        if (!extraData || (!extraData.length) || (extraData.length >= 1024 * 4)) {
          return;
        }
        if (!self.extraData) {
          self.extraData = {};
        }
        // 设计成可拓展的结构，防止以后有类似的字段增加需求
        self.extraData[type] = extraData;
      }
      var jsBridge = (function () {

        var callbacks = {
          showBox: function () {
            captchaObj.showBox && captchaObj.showBox();
          },
          postNativeMessage: function (data) {
            log('getCore time: ' + ((new Date()).getTime()));
            uploadExtraData('GeeToken', data)
            captchaObj.uploadExtraData && captchaObj.uploadExtraData('GeeToken', data);
          }
        };
        var call = function (data) {
          //调用原生方法
          try {
            window.ReactNativeWebView.postMessage(JSON.stringify(data))
          } catch (e) {
            log('调用navtive接口异常');
          }
        };

        return {
          callback: function (type, data) {
            return callbacks[type](data);
          },
          callNative: call
        }
      })();
      // 暴露 jsBridge
      window.jsBridge = jsBridge;
      // jsBridge 与 全局全局错误捕获要尽可能早的加载，防止gt4中的错误捕获不到；
      if (window.addEventListener) {
        window.addEventListener('error', function (e) {
          jsBridge.callNative({
            type: 'error',
            data: newError(`Veeecai-Verification Version: ${'0.0.1-test'} `, 39563, e.message)
          });
        })
      } else {
        window.onerror = function (e) {
          jsBridge.callNative({
            type: 'error',
            data: newError(`Veeecai-Verification Version: ${'0.0.1-test'} `, 39563, e.message)
          });
        }
      }
    })();
  </script>

  <script>

    (function () {
      //geeToken兼容ai下无token
      if (!isOffline) {
        // 非宕机模式下获取移动端coreSDK数据
        jsBridge.callNative({
          type: 'get'
        })
      }
      var startTime = 0;
      var clearID = 0;
      var captcha = document.getElementById('captcha');


      var query = location.href.split('?')[1];


      // 兼容低版本Object.assign
      if (typeof Object.assign != 'function') {
        // Must be writable: true, enumerable: false, configurable: true
        Object.defineProperty(Object, "assign", {
          value: function assign(target, varArgs) { // .length of function is 2
            if (target == null) { // TypeError if undefined or null
              throw new TypeError('Cannot convert undefined or null to object');
            }

            var to = Object(target);

            for (var index = 1; index < arguments.length; index++) {
              var nextSource = arguments[index];

              if (nextSource != null) { // Skip over if undefined or null
                for (var nextKey in nextSource) {
                  // Avoid bugs when hasOwnProperty is shadowed
                  if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {
                    to[nextKey] = nextSource[nextKey];
                  }
                }
              }
            }
            return to;
          },
          writable: true,
          configurable: true
        });
      }

      // 默认配置
      var config = {
        product: 'bind',
        onError: function (e) {
          // 错误信息中插入版本号
          e.desc = Object.assign({}, e.desc, { indexVersion: indexVersion });
          jsBridge.callNative({
            type: 'error',
            data: e
          });
        }
      };

      function setDebug() {
        debug = true;
        logEle.className = 'log';
      }

      function paseURI() {
        return JSON.parse(decodeURIComponent(query.split('=')[1]));
      }

      function checkArgs(args) {
        //设置loading
        // img.src = args['loading'] ? args['loading'] : './gt4-loading.gif';

        // clearID = setTimeout(function () {
        //     img.style.display = 'inline-block';
        // }, 200);

        // 是否开启debug
        if (args['debug']) {
          setDebug(true);
          startTime = (new Date()).getTime();
          log(JSON.stringify(args))
        }

        // 设置title
        if (args['title'] && args['title'] != "") {
          var h3 = document.createElement('h3');
          h3.className = 'title';
          h3.appendChild(document.createTextNode(decodeURIComponent(args['title'])));
          captcha.appendChild(h3);
        }

        // 检查必要参数
        if (!args['captchaId']) {
          log('args error: ' + query);
        }

        // 通过useLocalOffline判断是否会加入宕机效验
        if (args['useLocalOffline']) {
          //宕机启用自己的方法
          config.offlineCb = function () {

            isOffline = true;

            jsBridge.callNative({
              type: 'result',
              data: {
                captcha_id: args['captchaId'],
                challenge: args['challenge'],
                offline: true
              }
            });
          }
        }
      }

      function mergeOptions(args) {
        for (var k in args) {
          if (args.hasOwnProperty(k) &&
            ['debug', 'title', args['type']].indexOf(k) === -1) {
            config[k] = args[k];
          }
        }
      }

      if (!query) {
        setDebug();
        log('no query: ' + location.href);
        return false;
      }

      console.log(query, 'query')
      // 解析参数
      var args = paseURI(query);

      // 检查参数
      checkArgs(args);

      // 合并配置项
      mergeOptions(args);

      window.VecAICaptcha({
        onSuccess: (data) => {
          jsBridge.callNative({
            type: 'success',
            data: 'OK'
          });
        },
        onClose: (data) => {
          jsBridge.callNative({
            type: 'close',
            data: 'OK'
          });
        },
        dom: 'VecAICaptchaDemo', // 自定义挂载元素： 传入ID即可，不需要携带"#" 
        isNohide: true
      });
    })();

  </script>


</body>

</html>